## MVCC

InnoDB 引擎支持 MVCC(Multiversion Concurrency Control)：InnoDB 保存了行的历史版本，以支持事务的并发控制和回滚。这些历史信息保存在表空间的 **回滚段（Rollback Segment）** 里，回滚段中存储着 **Undo Log**。当事务需要进行回滚时，InnoDB 就会使用这些信息来进行 Undo 操作，同时这些信息也可用来实现 **一致性读**。

InnoDB 在存储的每行数据中都增加了三列隐藏属性：

- `DB_TRX_ID`：最后一次插入或更新的事务ID
- `DB_ROLL_PTR`：指向已写入回滚段的 Undo Log 记录。如果这行记录是更新的，那么就可以根据这个 Undo Log 记录重建之间的数据
- `DB_ROW_ID`：自增序列，如果表未指定主键，则由该列作为主键

在回滚段的 Undo Log 被分为 `Insert Undo Log` 和 `Update Undo Log`。Insert Undo Log 只是在事务回滚的时候需要，在事务提交后就可丢弃。Update Undo Log 不仅仅在回滚的时候需要，还要提供一致性读，所以只有在所有需要该 Update Undo Log 构建历史版本数据的事务都提交后才能丢弃。MySQL 建议尽量频繁的提交事务，这样可以保证 InnoDB 快速的丢弃 Update Undo Log，防止其过大。

在 InnoDB 中，行数据的物理删除不是立刻执行，InnoDB 会在行删除的 Undo Log 被丢弃时才会进行物理删除。这个过程被称之为 **清理（Purge）**，其执行过程十分迅速。

### MVCC 二级索引

InnoDB 在更新时对 二级索引 和 聚集索引的处理方式不一样。在聚集索引上的更新是原地更新（in-place），其中的隐藏属性 `DB_ROLL_PTR` 指向的 Undo Log 可以重建历史数据。但是二级索引没有隐藏属性，所以不能原地更新。

当二级索引的数据被更新时，旧的二级索引记录标记为 **标记删除（delete-marked）**，然后插入一条新的索引记录，最终标记删除的索引记录会被清除。当二级索引记录被标记为 delete-marked 或者有更新的事务更新时，InnoDB 会查找聚集索引。在聚集索引中检查行的 `DB_TRX_ID`，如果事务修改了记录，则从 Undo Log 中构建行数据的正确版本。如果二级索引记录被标记为 delete-marked 或者 二级索引有更新的事务更新，覆盖索引技术不会被使用（获取行任意数据均需要回表）。

### MVCC vs 乐观锁

**MVCC 并不是一个与乐观和悲观并发控制对立的东西，它能够与两者很好的结合以增加事务的并发量**，在目前最流行的 SQL 数据库 MySQL 和 PostgreSQL 中都对 MVCC 进行了实现；但是由于它们分别实现了悲观锁和乐观锁，所以 MVCC 实现的方式也不同。

MVCC 可以保证不阻塞地读到一致的数据。但是，MVCC 并没有对实现细节做约束，为此不同的数据库的语义有所不同，比如：

- `postgres` 对写操作也是乐观并发控制；在表中保存同一行数据记录的多个不同版本，每次写操作，都是创建，而回避更新；在事务提交时，按版本号检查当前事务提交的数据是否存在写冲突，则抛异常告知用户，回滚事务；
- `innodb` 则只对读无锁，写操作仍是上锁的悲观并发控制，这也意味着，`innodb` 中只能见到因死锁和不变性约束而回滚，而见不到因为写冲突而回滚，不像 postgres 那样对数据修改在表中创建新纪录，而是每行数据只在表中保留一份，在更新数据时上行锁，同时将旧版数据写入 `undo log`。表和 undo log 中行数据都记录着事务ID，在检索时，只读取来自当前已提交的事务的行数据。

可见 MVCC 中的写操作仍可以按悲观并发控制实现，而 `CAS` 的写操作只能是乐观并发控制。还有一个不同在于，MVCC 在语境中倾向于 “对多行数据打快照造平行宇宙”，然而 `CAS` 一般只是保护单行数据而已。比如 mongodb 有 CAS 的支持，但不能说这是 MVCC。

### mvcc

> ​	InnoDB 通过行 多版本控制的方式来读取 当前执行时刻，数据库中的数据。
>
> ​	一致性的非锁定读：
>
> ​		如果读取的行正在执行 delete 或 update 操作，这时读取操作不会去等待行上锁的释放，而是读取行上的一份快照数据。在事务隔离级别 Read Committed 和 Repeatable Read 下，InnoDB 使用非锁定的一致性读。
>
> ​	在Read Committed 事务隔离级别下，对于快照数据，非一致性读总是读取被锁定行的最新一份快照数据；
>
> ​	在Repeatable Read 事务隔离级别下，对于快照数据，非一致性读总是读取事务开始时的行数据版本。
>
> ​	一个行不止一份快照数据，由此带来的并发控制，称为多版本并发控制 MVCC (Multi Version Concurrency Control)